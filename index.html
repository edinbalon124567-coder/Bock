<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Kare Oyunu</title>

<style>
body { margin:0; background:#222; font-family:Arial; }
canvas { background:#ddd; display:block; margin:0 auto; }

#chat {
  position:fixed;
  right:10px;
  bottom:10px;
  width:260px;
  height:220px;
  background:#fff;
  border:1px solid #999;
  display:flex;
  flex-direction:column;
}
#messages { flex:1; overflow-y:auto; padding:6px; font-size:14px; }
#chat input { border:none; border-top:1px solid #ccc; padding:8px; }

#mobile {
  position:fixed;
  left:10px;
  bottom:10px;
  display:grid;
  grid-template-columns:repeat(3,50px);
  gap:5px;
}
.btn {
  width:50px;
  height:50px;
  background:#bbb;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
}
</style>
</head>

<body>

<canvas id="game" width="800" height="500"></canvas>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Mesaj yaz...">
</div>

<div id="mobile">
  <div></div><div class="btn" data-k="w">↑</div><div></div>
  <div class="btn" data-k="a">←</div><div class="btn" data-k="s">↓</div><div class="btn" data-k="d">→</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, set, onValue, push,
  onDisconnect, remove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyA49KR-d9hN6QXXcvZ68CfYLpMulad8p50",
  authDomain: "multiplayer-chat-552f7.firebaseapp.com",
  databaseURL: "https://multiplayer-chat-552f7-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "multiplayer-chat-552f7",
  storageBucket: "multiplayer-chat-552f7.firebasestorage.app",
  messagingSenderId: "658594907764",
  appId: "1:658594907764:web:18ca661bd9dd9f504df321"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* PLAYER */
const playerId = "player_" + Math.floor(Math.random()*99999);
const playerRef = ref(db, "players/" + playerId);

let myPlayer = { x: 100, y: 100 };
let players = {};

// refresh / çıkışta sil
onDisconnect(playerRef).remove();
set(playerRef, myPlayer);

// diğer oyuncuları al
onValue(ref(db, "players"), snap => {
  players = snap.val() || {};
});

/* CANVAS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // map
  ctx.fillStyle = "#ddd";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // players
  for (const id in players) {
    const p = players[id];
    if (!p) continue;

    ctx.fillStyle = id === playerId ? "blue" : "red";
    ctx.fillRect(p.x, p.y, 30, 30);

    ctx.fillStyle = "#000";
    ctx.font = "12px Arial";
    ctx.fillText(id === playerId ? "Sen" : "Rakip", p.x, p.y - 5);
  }

  requestAnimationFrame(draw);
}
draw();

/* CONTROLS */
const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

setInterval(() => {
  let moved = false;

  if (keys.w) { myPlayer.y -= 4; moved = true; }
  if (keys.s) { myPlayer.y += 4; moved = true; }
  if (keys.a) { myPlayer.x -= 4; moved = true; }
  if (keys.d) { myPlayer.x += 4; moved = true; }

  myPlayer.x = Math.max(0, Math.min(canvas.width-30, myPlayer.x));
  myPlayer.y = Math.max(0, Math.min(canvas.height-30, myPlayer.y));

  if (moved) set(playerRef, myPlayer);
}, 40);

// mobile
document.querySelectorAll(".btn").forEach(btn => {
  btn.addEventListener("touchstart", () => keys[btn.dataset.k] = true);
  btn.addEventListener("touchend", () => keys[btn.dataset.k] = false);
});

/* CHAT */
const chatInput = document.getElementById("chatInput");
const messages = document.getElementById("messages");

chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && chatInput.value.trim()) {
    push(ref(db,"chat"), { user: playerId, text: chatInput.value });
    chatInput.value = "";
  }
});

onValue(ref(db,"chat"), snap => {
  messages.innerHTML = "";
  snap.forEach(m => {
    const d = m.val();
    messages.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`;
  });
  messages.scrollTop = messages.scrollHeight;
});
</script>

</body>
</html>
