<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basit Multiplayer Kare Oyunu</title>
  <style>
    body { margin:0; font-family:Arial; background:#222; }
    canvas { background:#eee; display:block; margin:0 auto; }
    #chat {
      position: fixed;
      right: 10px;
      bottom: 10px;
      width: 260px;
      height: 220px;
      background: white;
      border: 1px solid #999;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    #messages { flex:1; overflow-y:auto; padding:6px; font-size:14px; }
    #chat input { border:none; border-top:1px solid #ccc; padding:8px; }
    #mobile {
      position: fixed;
      left: 10px;
      bottom: 10px;
      display: grid;
      grid-template-columns: repeat(3, 50px);
      gap: 5px;
      z-index: 10;
    }
    .btn {
      width:50px; height:50px;
      background:#bbb;
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; user-select:none;
    }
  </style>
</head>
<body>

<canvas id="game" width="800" height="500"></canvas>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Mesaj yaz..." />
</div>

<div id="mobile">
  <div></div><div class="btn" data-k="w">↑</div><div></div>
  <div class="btn" data-k="a">←</div><div class="btn" data-k="s">↓</div><div class="btn" data-k="d">→</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA49KR-d9hN6QXXcvZ68CfYLpMulad8p50",
    authDomain: "multiplayer-chat-552f7.firebaseapp.com",
    databaseURL: "https://multiplayer-chat-552f7-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "multiplayer-chat-552f7",
    storageBucket: "multiplayer-chat-552f7.firebasestorage.app",
    messagingSenderId: "658594907764",
    appId: "1:658594907764:web:18ca661bd9dd9f504df321"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === PLAYER ===
  const playerId = 'player_' + Math.floor(Math.random() * 99999);
  const playerRef = ref(db, 'players/' + playerId);

  let myPlayer = { x: 100, y: 100 };
  let players = {};

  // Oyuncu sayısını 2 ile sınırla ve klonları temizle
  import { onDisconnect, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const playersRef = ref(db, 'players');

  // Bağlantı kopunca oyuncuyu sil
  onDisconnect(playerRef).remove();

  // Oyuncuyu kaydet
  function syncPlayer() {
    set(playerRef, myPlayer);
  }

  // Eski / klon oyuncuları temizle (max 2 oyuncu)
  get(playersRef).then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      const ids = Object.keys(data);
      if (ids.length >= 2) {
        // Fazla oyuncuları sil
        ids.slice(1).forEach(id => {
          remove(ref(db, 'players/' + id));
        });
      }
    }
    syncPlayer();
  });

  // === CONTROLS ===
  const keys = {};
  window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
  window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

  setInterval(() => {
    let moved = false;
    if (keys.w) { myPlayer.y -= 4; moved = true; }
    if (keys.s) { myPlayer.y += 4; moved = true; }
    if (keys.a) { myPlayer.x -= 4; moved = true; }
    if (keys.d) { myPlayer.x += 4; moved = true; }

    myPlayer.x = Math.max(0, Math.min(canvas.width - 30, myPlayer.x));
    myPlayer.y = Math.max(0, Math.min(canvas.height - 30, myPlayer.y));

    if (moved) syncPlayer();
  }, 40);

  // MOBILE
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('touchstart', () => keys[btn.dataset.k] = true);
    btn.addEventListener('touchend', () => keys[btn.dataset.k] = false);
  });

  // === CHAT ===
  const chatInput = document.getElementById('chatInput');
  const messages = document.getElementById('messages');

  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && chatInput.value.trim()) {
      push(ref(db, 'chat'), { user: playerId, text: chatInput.value });
      chatInput.value = '';
    }
  });

  onValue(ref(db, 'chat'), snap => {
    messages.innerHTML = '';
    snap.forEach(c => {
      const m = c.val();
      messages.innerHTML += `<div><b>${m.user}:</b> ${m.text}</div>`;
    });
    messages.scrollTop = messages.scrollHeight;
  });
</script>

</body>
</html>
